name: Build GUI

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag (e.g., v0.17.0)'
        required: false
        type: string

env:
  GO_VERSION: '1.25.5'
  NODE_VERSION: '18'

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Run Tests First
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run CLI tests
        run: |
          # Test all packages except GUI
          TEST_INTENSITY=thorough go test \
            ./internal/... \
            ./cmd/fast-file-deletion/...

      - name: Verify cross-platform compilation (CLI only)
        run: |
          echo "Verifying CLI compiles on all platforms..."
          GOOS=windows GOARCH=amd64 go build -o /dev/null ./cmd/fast-file-deletion
          echo "✓ Windows AMD64"
          GOOS=linux GOARCH=amd64 go build -o /dev/null ./cmd/fast-file-deletion
          echo "✓ Linux AMD64"
          GOOS=darwin GOARCH=amd64 go build -o /dev/null ./cmd/fast-file-deletion
          echo "✓ macOS AMD64"
          GOOS=darwin GOARCH=arm64 go build -o /dev/null ./cmd/fast-file-deletion
          echo "✓ macOS ARM64"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build CLI for All Platforms
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  build-cli:
    name: Build CLI
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build all CLI binaries
        run: make build-all

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-binaries
          path: bin/fast-file-deletion-*
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build GUI for Windows
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  build-gui-windows:
    name: Build GUI (Windows)
    runs-on: windows-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Generate Wails bindings
        run: |
          cd cmd/ffd-gui
          wails3 generate bindings
          Copy-Item -Recurse -Force frontend/bindings ../../frontend/

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build GUI
        run: |
          cd cmd/ffd-gui
          wails3 build

      - name: Copy binary to bin/
        run: |
          New-Item -ItemType Directory -Force -Path bin
          Copy-Item cmd/ffd-gui/build/bin/ffd-gui.exe bin/ffd-gui.exe

      - name: Upload Windows GUI
        uses: actions/upload-artifact@v4
        with:
          name: gui-windows
          path: bin/ffd-gui.exe
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build GUI for macOS
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  build-gui-macos:
    name: Build GUI (macOS)
    runs-on: macos-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Generate Wails bindings
        run: |
          cd cmd/ffd-gui
          ~/go/bin/wails3 generate bindings
          cp -rf frontend/bindings ../../frontend/

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build GUI
        run: |
          cd cmd/ffd-gui
          ~/go/bin/wails3 build

      - name: Copy binary to bin/
        run: |
          mkdir -p bin
          cp cmd/ffd-gui/build/bin/ffd-gui bin/ffd-gui

      - name: Upload macOS GUI
        uses: actions/upload-artifact@v4
        with:
          name: gui-macos
          path: bin/ffd-gui
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build GUI for Linux
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  build-gui-linux:
    name: Build GUI (Linux)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webkit2gtk-4.0-dev libgtk-3-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Generate Wails bindings
        run: |
          cd cmd/ffd-gui
          ~/go/bin/wails3 generate bindings
          cp -rf frontend/bindings ../../frontend/

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build GUI
        run: |
          cd cmd/ffd-gui
          ~/go/bin/wails3 build

      - name: Copy binary to bin/
        run: |
          mkdir -p bin
          cp cmd/ffd-gui/build/bin/ffd-gui bin/ffd-gui

      - name: Upload Linux GUI
        uses: actions/upload-artifact@v4
        with:
          name: gui-linux
          path: bin/ffd-gui
          retention-days: 30

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Create Release (on tags only)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-cli, build-gui-windows, build-gui-macos, build-gui-linux]
    if: github.event.inputs.create_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # CLI binaries
          cp artifacts/cli-binaries/* release/

          # GUI binaries (rename for clarity)
          cp artifacts/gui-windows/ffd-gui.exe release/ffd-gui-windows.exe
          cp artifacts/gui-macos/ffd-gui release/ffd-gui-macos
          cp artifacts/gui-linux/ffd-gui release/ffd-gui-linux

          # Create checksums
          cd release
          sha256sum * > SHA256SUMS
          cd ..

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            echo "VERSION=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Create release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Fast File Deletion ${{ steps.version.outputs.VERSION }}

          ### Downloads

          #### GUI (Recommended for most users)
          - **Windows**: `ffd-gui-windows.exe` (15-20 MB)
          - **macOS**: `ffd-gui-macos` (15-20 MB)
          - **Linux**: `ffd-gui-linux` (15-20 MB)

          #### CLI (For automation and power users)
          - **Windows AMD64**: `fast-file-deletion-windows-amd64.exe`
          - **Windows ARM64**: `fast-file-deletion-windows-arm64.exe`
          - **Linux AMD64**: `fast-file-deletion-linux-amd64`
          - **Linux ARM64**: `fast-file-deletion-linux-arm64`
          - **macOS AMD64**: `fast-file-deletion-darwin-amd64`
          - **macOS ARM64**: `fast-file-deletion-darwin-arm64` (Apple Silicon)

          ### What's New

          - Modern Windows 11 GUI with Fluent Design
          - Real-time deletion rate visualization
          - System resource monitoring
          - All 12 CLI options available in GUI
          - Security improvements (TOCTOU protection)

          ### Performance

          - **Deletion rate**: 400-1,200 files/sec (disk I/O bound)
          - **Memory usage**: Dynamic allocation (25% of RAM)
          - **Real-world test**: 1,023,444 files in 36m39s (465 files/sec)

          ### Requirements

          - **Windows**: Windows 10 1809+ or Windows 11 (WebView2 pre-installed on Win11)
          - **macOS**: macOS 10.13+ (High Sierra or later)
          - **Linux**: GTK 3.18+, webkit2gtk-4.0

          ### Installation

          1. Download the appropriate binary for your platform
          2. (Windows) Make executable: No action needed, `.exe` files run directly
          3. (macOS/Linux) Make executable: `chmod +x ffd-gui-*`
          4. Run the application

          ### Verification

          ```bash
          # Verify checksums (recommended)
          sha256sum -c SHA256SUMS
          ```

          ### Documentation

          - [README](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/README.md)
          - [GUI Testing Guide](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/GUI_TESTING.md)
          - [Build Instructions](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/GUI_BUILD.md)

          ### Support

          - Report issues: https://github.com/${{ github.repository }}/issues
          - Discussions: https://github.com/${{ github.repository }}/discussions
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Build Summary
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-cli, build-gui-windows, build-gui-macos, build-gui-linux]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CLI Build**: ${{ needs.build-cli.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GUI Windows**: ${{ needs.build-gui-windows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GUI macOS**: ${{ needs.build-gui-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GUI Linux**: ${{ needs.build-gui-linux.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download binaries from the Actions artifacts section above." >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub release will be created with all binaries." >> $GITHUB_STEP_SUMMARY
            echo "Version: ${{ github.event.inputs.release_tag || 'dev build' }}" >> $GITHUB_STEP_SUMMARY
          fi
